#############################################################
# Logstash Configuration for API Log Management
# Receives JSON logs via TCP on port 5000
#############################################################

input {
  # TCP input for receiving logs from Winston
  tcp {
    port => 5000
    codec => json
    type => "api-logs"
  }
}

filter {
  # Parse timestamp if it's a string
  if [timestamp] {
    date {
      match => [ "timestamp", "yyyy-MM-dd HH:mm:ss", "ISO8601" ]
      target => "@timestamp"
    }
  }
  
  # Add environment info
  mutate {
    add_field => {
      "log_source" => "nodejs-api"
      "[@metadata][pipeline]" => "api-pipeline"
    }
  }
  
  # Parse error stack traces
  if [error][stack] {
    mutate {
      copy => { "[error][stack]" => "stack_trace" }
    }
  }
  
  # Categorize log levels
  if [level] == "error" {
    mutate {
      add_tag => [ "error" ]
    }
  } else if [level] == "warn" {
    mutate {
      add_tag => [ "warning" ]
    }
  } else if [level] == "info" {
    mutate {
      add_tag => [ "info" ]
    }
  } else if [level] == "debug" {
    mutate {
      add_tag => [ "debug" ]
    }
  }
  
  # Extract HTTP request information if available
  if [method] and [url] {
    mutate {
      add_tag => [ "http_request" ]
    }
  }
  
  if [statusCode] {
    mutate {
      convert => { "statusCode" => "integer" }
    }
  }
}

output {
  # Output to file for persistence
  file {
    path => "/var/log/logstash/api-logs-%{+YYYY-MM-dd}.log"
    codec => json_lines
  }
  
  # Output to console for debugging (disable in production)
  stdout {
    codec => rubydebug {
      metadata => false
    }
  }
  
  # Elasticsearch output (uncomment and configure if using Elasticsearch)
  # elasticsearch {
  #   hosts => ["http://localhost:9200"]
  #   index => "api-logs-%{+YYYY.MM.dd}"
  #   document_type => "_doc"
  #   
  #   # Optional authentication
  #   # user => "elastic"
  #   # password => "your_password"
  # }
  
  # Send errors to a separate index/file
  if "error" in [tags] {
    file {
      path => "/var/log/logstash/api-errors-%{+YYYY-MM-dd}.log"
      codec => json_lines
    }
    
    # elasticsearch {
    #   hosts => ["http://localhost:9200"]
    #   index => "api-errors-%{+YYYY.MM.dd}"
    #   document_type => "_doc"
    # }
  }
}
